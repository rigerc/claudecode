name: Build Marketplace

on:
  push:
    branches: [ main, master ]
    paths:
      - 'plugins/**'
      - 'scripts/build-marketplace.py'
      - '.github/workflows/build-marketplace.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'plugins/**'
      - 'scripts/build-marketplace.py'
      - '.github/workflows/build-marketplace.yml'
  workflow_dispatch:

jobs:
  build-marketplace:
    runs-on: ubuntu-latest
    name: Build Marketplace & README

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        npm install -g markdownlint-cli2

    - name: Comprehensive plugin validation
      run: |
        echo "üîç Running comprehensive plugin validation..."
        python scripts/validate-plugins.py || {
          echo "‚ùå Plugin validation failed"
          exit 1
        }

        echo "‚úÖ Plugin validation passed!"

    - name: Build marketplace and README
      run: |
        echo "Building marketplace configuration and README..."
        python scripts/build-marketplace.py

        echo "Generated files:"
        echo "- .claude-plugin/marketplace.json"
        echo "- README.md"

        echo ""
        echo "Marketplace version info:"
        jq -r '.metadata.version // "1.0.0"' .claude-plugin/marketplace.json | xargs -I {} echo "Version: {}"
        jq -r '.metadata.lastUpdated // "unknown"' .claude-plugin/marketplace.json | xargs -I {} echo "Last Updated: {}"

        echo ""
        echo "Marketplace preview:"
        cat .claude-plugin/marketplace.json | jq .

    - name: Autofix and lint markdown files
      run: |
        echo "üîß Autofixing and linting markdown files..."

        # Configure git for potential commits
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Fix and lint plugin markdown files
        echo "Fixing plugin markdown files..."
        if [ -d "plugins" ]; then
          # Run autofix first
          echo "Running autofix on plugin files..."
          markdownlint-cli2 --fix "plugins/**/*.md" || {
            echo "‚ö†Ô∏è  Some plugin files had unfixable issues"
          }

          # Check if any files were changed
          if git diff --name-only --diff-filter=ACMRT | grep -q "\.md$"; then
            echo "üìù Markdown fixes detected in plugin files"
            git add "plugins/**/*.md"
            git commit -m "üîß Auto-fix markdown formatting issues in plugins" || {
              echo "No changes to commit (files might already be clean)"
            }
          fi

          # Now lint to verify all issues are resolved
          echo "Linting plugin markdown files..."
          markdownlint-cli2 "plugins/**/*.md" || {
            echo "‚ùå Markdown linting failed in plugins after autofix"
            echo "Some issues require manual intervention"
            exit 1
          }
          echo "‚úÖ Plugin markdown files linted successfully"
        else
          echo "‚ö†Ô∏è  No plugins directory found"
        fi

        # Fix and lint generated README.md
        echo "Fixing generated README.md..."
        if [ -f "README.md" ]; then
          # Run autofix on README.md
          echo "Running autofix on README.md..."
          markdownlint-cli2 --fix "README.md" || {
            echo "‚ö†Ô∏è  README.md had some unfixable issues"
          }

          # Check if README.md was changed
          if git diff --name-only --diff-filter=ACMRT | grep -q "README.md"; then
            echo "üìù Markdown fixes detected in README.md"
            git add "README.md"
            git commit -m "üîß Auto-fix markdown formatting issues in README.md" || {
              echo "No changes to commit (README.md might already be clean)"
            }
          fi

          # Lint to verify all issues are resolved
          echo "Linting generated README.md..."
          markdownlint-cli2 "README.md" || {
            echo "‚ùå README.md linting failed after autofix"
            echo "Some issues require manual intervention"
            exit 1
          }
          echo "‚úÖ README.md linted successfully"
        fi

        echo "‚úÖ All markdown files passed linting!"

    - name: Validate generated marketplace.json
      run: |
        echo "üîç Validating generated marketplace.json..."
        if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
          echo "‚ùå Generated marketplace.json is invalid JSON"
          exit 1
        fi

        # Run final validation on generated files
        echo "Running final validation on generated marketplace..."
        python scripts/validate-plugins.py --marketplace .claude-plugin/marketplace.json || {
          echo "‚ùå Generated marketplace validation failed"
          exit 1
        }

        # Validate plugin entries
        plugin_count=$(jq '.plugins | length' .claude-plugin/marketplace.json)
        echo "‚úÖ Found $plugin_count plugins in marketplace"

        if [ "$plugin_count" -eq 0 ]; then
          echo "‚ö†Ô∏è  Warning: No plugins found in marketplace"
        fi

    - name: Check for changes
      id: changes
      run: |
        # Clean up any untracked files first
        git clean -fd

        # Check for changes in the specific files we care about
        if [ -n "$(git status --porcelain .claude-plugin/marketplace.json README.md 2>/dev/null)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git status --porcelain .claude-plugin/marketplace.json README.md
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected in generated files"
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        echo "Committing generated files..."

        # Get version info for commit message
        NEW_VERSION=$(jq -r '.metadata.version // "unknown"' .claude-plugin/marketplace.json)
        PLUGIN_COUNT=$(jq '.plugins | length' .claude-plugin/marketplace.json)

        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add specific files
        git add .claude-plugin/marketplace.json README.md

        # Show what will be committed
        echo "Files to be committed:"
        git diff --cached --name-only

        # Check if there's anything to commit
        if [ -n "$(git diff --cached --name-only)" ]; then
          # Commit changes with version info
          git commit -m "ü§ñ Auto-update marketplace v${NEW_VERSION} (${PLUGIN_COUNT} plugins)

          # Push changes
          git push
          echo "Changes committed and pushed successfully"
          echo "Marketplace updated to version ${NEW_VERSION}"
        else
          echo "No changes to commit"
        fi

    - name: Create summary
      run: |
        echo "## üèóÔ∏è Marketplace Build Summary" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "‚úÖ **Status**: Changes detected and committed" >> $GITHUB_STEP_SUMMARY
          echo "üìù **Files Updated**:" >> $GITHUB_STEP_SUMMARY
          echo "- \`.claude-plugin/marketplace.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`README.md\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ÑπÔ∏è **Status**: No changes needed" >> $GITHUB_STEP_SUMMARY
        fi

        # Get marketplace info
        plugin_count=$(jq '.plugins | length' .claude-plugin/marketplace.json 2>/dev/null || echo "0")
        marketplace_version=$(jq -r '.metadata.version // "1.0.0"' .claude-plugin/marketplace.json 2>/dev/null || echo "1.0.0")
        last_updated=$(jq -r '.metadata.lastUpdated // "unknown"' .claude-plugin/marketplace.json 2>/dev/null || echo "unknown")

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üì¶ **Marketplace Info**:" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: \`$marketplace_version\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Plugin Count**: $plugin_count" >> $GITHUB_STEP_SUMMARY
        echo "- **Last Updated**: \`$last_updated\`" >> $GITHUB_STEP_SUMMARY

        if [ "$plugin_count" -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîå **Available Plugins**:" >> $GITHUB_STEP_SUMMARY
          jq -r '.plugins[] | "- \(.name)"' .claude-plugin/marketplace.json 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No plugins found"
        fi

        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üöÄ **Deployment**: Marketplace version \`$marketplace_version\` is now live!" >> $GITHUB_STEP_SUMMARY
        fi

  # Job to validate the generated files on PRs
  validate-pr:
    runs-on: ubuntu-latest
    name: Validate PR Changes
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Build marketplace and README
      run: python scripts/build-marketplace.py

    - name: Check if PR includes marketplace updates
      run: |
        echo "Checking if PR should include marketplace updates..."

        # Check if there are changes in plugins directory
        if git diff --name-only origin/${{ github.base_ref }} | grep -q "^plugins/"; then
          echo "üîç Plugin changes detected in PR"

          # Check if marketplace files are also updated
          if git diff --name-only origin/${{ github.base_ref }} | grep -E "^(README\.md|\.claude-plugin/marketplace\.json)$"; then
            echo "‚úÖ Marketplace files updated in PR"
          else
            echo "‚ö†Ô∏è  WARNING: Plugin changes detected but marketplace files not updated!"
            echo "Please run 'python scripts/build-marketplace.py' and commit the changes."
            exit 1
          fi
        else
          echo "‚ÑπÔ∏è  No plugin changes in PR"
        fi