name: Build Marketplace

on:
  push:
    branches: [ main, master ]
    paths:
      - 'plugins/**'
      - 'scripts/build-marketplace.py'
      - '.github/workflows/build-marketplace.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'plugins/**'
      - 'scripts/build-marketplace.py'
      - '.github/workflows/build-marketplace.yml'
  workflow_dispatch:

jobs:
  build-marketplace:
    runs-on: ubuntu-latest
    name: Build Marketplace & README

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Comprehensive plugin validation
      run: |
        echo "üîç Running comprehensive plugin validation..."
        python scripts/validate-plugins.py --format json > validation-results.json || {
          echo "‚ùå Plugin validation failed"
          cat validation-results.json
          exit 1
        }

        echo "‚úÖ Plugin validation passed!"

    - name: Build marketplace and README
      run: |
        echo "Building marketplace configuration and README..."
        python scripts/build-marketplace.py

        echo "Generated files:"
        echo "- .claude-plugin/marketplace.json"
        echo "- README.md"

        echo ""
        echo "Marketplace preview:"
        cat .claude-plugin/marketplace.json | jq .

    - name: Validate generated marketplace.json
      run: |
        echo "üîç Validating generated marketplace.json..."
        if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
          echo "‚ùå Generated marketplace.json is invalid JSON"
          exit 1
        fi

        # Run final validation on generated files
        echo "Running final validation on generated marketplace..."
        python scripts/validate-plugins.py --marketplace .claude-plugin/marketplace.json || {
          echo "‚ùå Generated marketplace validation failed"
          exit 1
        }

        # Validate plugin entries
        plugin_count=$(jq '.plugins | length' .claude-plugin/marketplace.json)
        echo "‚úÖ Found $plugin_count plugins in marketplace"

        if [ "$plugin_count" -eq 0 ]; then
          echo "‚ö†Ô∏è  Warning: No plugins found in marketplace"
        fi

    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git status --porcelain
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        echo "Committing generated files..."

        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add changes
        git add .claude-plugin/marketplace.json README.md

        # Show what will be committed
        echo "Files to be committed:"
        git diff --cached --name-only

        # Commit changes
        git commit -m "ü§ñ Auto-update marketplace and README from plugin changes"

        # Push changes
        git push

    - name: Create summary
      run: |
        echo "## üèóÔ∏è Marketplace Build Summary" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "‚úÖ **Status**: Changes detected and committed" >> $GITHUB_STEP_SUMMARY
          echo "üìù **Files Updated**:" >> $GITHUB_STEP_SUMMARY
          echo "- \`.claude-plugin/marketplace.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`README.md\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ÑπÔ∏è **Status**: No changes needed" >> $GITHUB_STEP_SUMMARY
        fi

        plugin_count=$(jq '.plugins | length' .claude-plugin/marketplace.json 2>/dev/null || echo "0")
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üì¶ **Plugin Count**: $plugin_count" >> $GITHUB_STEP_SUMMARY

        if [ "$plugin_count" -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîå **Available Plugins**:" >> $GITHUB_STEP_SUMMARY
          jq -r '.plugins[] | "- \(.name)"' .claude-plugin/marketplace.json 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No plugins found"
        fi

  # Job to validate the generated files on PRs
  validate-pr:
    runs-on: ubuntu-latest
    name: Validate PR Changes
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Build marketplace and README
      run: python scripts/build-marketplace.py

    - name: Check if PR includes marketplace updates
      run: |
        echo "Checking if PR should include marketplace updates..."

        # Check if there are changes in plugins directory
        if git diff --name-only origin/${{ github.base_ref }} | grep -q "^plugins/"; then
          echo "üîç Plugin changes detected in PR"

          # Check if marketplace files are also updated
          if git diff --name-only origin/${{ github.base_ref }} | grep -E "^(README\.md|\.claude-plugin/marketplace\.json)$"; then
            echo "‚úÖ Marketplace files updated in PR"
          else
            echo "‚ö†Ô∏è  WARNING: Plugin changes detected but marketplace files not updated!"
            echo "Please run 'python scripts/build-marketplace.py' and commit the changes."
            exit 1
          fi
        else
          echo "‚ÑπÔ∏è  No plugin changes in PR"
        fi