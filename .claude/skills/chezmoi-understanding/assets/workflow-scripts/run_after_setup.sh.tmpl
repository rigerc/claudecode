#!/bin/bash
# Post-setup script
# This script runs after all files have been applied

set -e

echo "Running post-setup tasks..."

# Detect machine type
{{ if eq .chezmoi.hostname "work-laptop" }}
MACHINE_TYPE="work"
{{ else }}
MACHINE_TYPE="personal"
{{ end }}

echo "Machine type: $MACHINE_TYPE"

# Set shell if needed
if [[ "$SHELL" != *"{{ .shell | default "bash" }}"* ]]; then
    echo "Changing default shell to {{ .shell | default "bash" }}..."

    {{ if eq .shell "zsh" }}
    if command -v zsh &> /dev/null; then
        chsh -s $(which zsh)
        echo "Default shell changed to zsh. Please log out and log back in."
    else
        echo "zsh is not installed. Default shell not changed."
    fi
    {{ else }}
    # bash is usually the default, no action needed
    echo "Shell is already bash or shell change not needed."
    {{ end }}
fi

# Create necessary directories
echo "Creating directories..."
mkdir -p ~/.local/bin
mkdir -p ~/.local/share
mkdir -p ~/.config
mkdir -p ~/Downloads
mkdir -p ~/Documents
mkdir -p ~/Pictures
mkdir -p ~/Videos
mkdir -p ~/Music
mkdir -p ~/Projects

{{ if .development.go }}
# Create Go directories
echo "Creating Go directories..."
mkdir -p ~/go/bin
mkdir -p ~/go/src
mkdir -p ~/go/pkg
{{ end }}

# Set up Git global configuration (if not already set)
if command -v git &> /dev/null; then
    echo "Configuring Git..."

    if ! git config --global user.email &> /dev/null; then
        git config --global user.email "{{ .email }}"
        echo "Set git email to {{ .email }}"
    fi

    {{ if eq .chezmoi.hostname "work-laptop" }}
    if ! git config --global user.name &> /dev/null; then
        git config --global user.name "{{ .name_work }}"
        echo "Set git name to {{ .name_work }}"
    fi
    {{ else }}
    if ! git config --global user.name &> /dev/null; then
        git config --global user.name "{{ .name_personal }}"
        echo "Set git name to {{ .name_personal }}"
    fi
    {{ end }}

    # Set default branch name
    git config --global init.defaultBranch main

    # Set safe directory for chezmoi source directory
    git config --global safe.directory "$HOME/.local/share/chezmoi"
fi

# Initialize chezmoi git repository if needed
if [[ -d "$HOME/.local/share/chezmoi" ]]; then
    cd "$HOME/.local/share/chezmoi"

    if ! git remote get-url origin &> /dev/null; then
        echo "Chezmoi repository has no remote origin."
        echo "To set up remote repository, run:"
        echo "  chezmoi cd"
        echo "  git remote add origin https://github.com/YOUR_USERNAME/dotfiles.git"
        echo "  git push -u origin main"
        echo "  exit"
    else
        echo "Chezmoi repository is already configured with remote origin."
    fi
fi

# Machine-specific setup
{{ if eq .chezmoi.hostname "work-laptop" }}
# Work-specific setup
echo "Performing work-specific setup..."

# Create work directories
mkdir -p ~/work
mkdir -p ~/work/projects

# Set up work SSH config if needed
if [[ ! -f "$HOME/.ssh/work_config" ]]; then
    echo "# Work SSH configuration" > ~/.ssh/work_config
    echo "# Add your work SSH hosts here" >> ~/.ssh/work_config
    echo "Created ~/.ssh/work_config for work SSH settings."
fi

{{ else }}
# Personal setup
echo "Performing personal setup..."

# Create personal directories
mkdir -p ~/personal
mkdir -p ~/personal/projects
mkdir -p ~/personal/scripts

# Set up personal Git configurations
if command -v git &> /dev/null; then
    # Set up Git user for personal repositories
    git config --global user.name "{{ .name_personal }}"
    git config --global user.email "{{ .email }}"
fi
{{ end }}

# Display summary
echo ""
echo "=== Post-Setup Summary ==="
echo "Machine: {{ .chezmoi.hostname }}"
echo "OS: {{ .chezmoi.os }} ({{ .chezmoi.arch }})"
echo "Machine type: $MACHINE_TYPE"
echo ""

{{ if .development }}
echo "Development environment:"
{{ if .development.go }}
echo "- Go: $(go version 2>/dev/null || echo 'Not installed')"
{{ end }}
{{ if .development.node }}
echo "- Node.js: $(node --version 2>/dev/null || echo 'Not installed')"
{{ end }}
{{ if .development.python }}
echo "- Python: $(python --version 2>/dev/null || echo 'Not installed')"
{{ end }}
echo ""
{{ end }}

echo "Next steps:"
echo "1. Restart your terminal or run: source ~/.bashrc"
{{ if .development }}
echo "2. Install development tools if not already installed"
{{ end }}
echo "3. Customize your configuration files as needed"
echo "4. Commit and push your dotfiles to remote repository:"
echo "   chezmoi cd"
echo "   git add ."
echo "   git commit -m 'Initial setup for {{ .chezmoi.hostname }}'"
echo "   git push origin main"
echo "   exit"

echo ""
echo "Setup completed successfully! ðŸŽ‰"